<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PolitMap | Интерактивная карта СВОl</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --army-red: #8b0000;
            --khaki: #c2b280;
            --sidebar-bg: #0d0d0d;
            --border-color: #222;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; color: #ccc; }

        /* ТАБ БАР */
        #tab-bar { width: 60px; min-width: 60px; background: #111; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 10001; }
        
        #sidebar { 
            width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); 
            z-index: 10000; display: flex; flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #sidebar.collapsed { width: 0; min-width: 0; border-right: none; transform: translateX(-10px); opacity: 0; pointer-events: none; }

        .tab-btn { width: 44px; height: 44px; color: #444; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 20px; border-radius: 8px; transition: 0.2s; }
        .tab-btn.active { color: var(--khaki); background: #1a1e16; border: 1px solid #3b4634; }
        .tab-btn svg { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }

        .tab-page { display: none; padding: 25px 20px; height: 100%; overflow-y: auto; min-width: 300px; }
        .tab-page.active { display: block; }

        h2 { font-size: 11px; letter-spacing: 2px; color: #555; margin-bottom: 20px; text-transform: uppercase; }

        /* КНОПКИ */
        .tool-btn { width: 100%; padding: 12px; background: #151515; border: 1px solid #333; color: #888; margin-bottom: 8px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 12px; display: flex; align-items: center; gap: 10px; }
        .tool-btn.active { border-color: var(--khaki); color: #fff; background: #1a1e16; }

        /* ПЛАШКА ПОДДЕРЖКИ */
        .support-card {
            background: #111;
            border: 1px solid #222;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .card-number-box {
            background: #000;
            border: 1px solid var(--army-red);
            padding: 12px;
            border-radius: 4px;
            color: #fff;
            font-family: monospace;
            font-size: 16px;
            text-align: center;
            letter-spacing: 1px;
            margin: 10px 0;
        }
        .copy-btn {
            width: 100%;
            padding: 10px;
            background: var(--army-red);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
            text-transform: uppercase;
        }
        .copy-btn:active { opacity: 0.7; }

        /* КАРТА */
        #map-wrap { position: relative; flex-grow: 1; height: 100vh; z-index: 1; }
        #map { height: 100%; width: 100%; z-index: 10; background: #000; }
        #paint-canvas { position: absolute; top: 0; left: 0; z-index: 5000; width: 100%; height: 100%; touch-action: none; pointer-events: none; }
        #paint-canvas.active { pointer-events: auto; }

        /* ТОЧКИ */
        .pulsating-dot { width: 14px; height: 14px; background: #ff3b3b; border-radius: 50%; border: 2px solid #fff; animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255, 59, 59, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 59, 59, 0); }
            100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255, 59, 59, 0); }
        }
        .custom-tooltip { background: #000 !important; border: 1px solid var(--khaki) !important; color: #fff !important; font-weight: bold; }

        .switch-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 12px; background: #151515; border-radius: 6px; }
        .switch { position: relative; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #333; border-radius: 22px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background: var(--army-red); }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body>

<div id="tab-bar">
    <div class="tab-btn active" id="btn-map" onclick="toggleTab('map')">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
    </div>
    <div class="tab-btn" id="btn-draw" onclick="toggleTab('draw')">
        <svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
    </div>
    <div class="tab-btn" id="btn-don" onclick="toggleTab('don')">
        <svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M6 12h.01M18 12h.01"/></svg>
    </div>
</div>

<div id="sidebar">
    <div id="t-map" class="tab-page active">
        <h2>Карта</h2>
        <div class="switch-group"><span>Спутник + OSM</span><label class="switch"><input type="checkbox" id="sat-switch" onchange="toggleLayers()"><span class="slider"></span></label></div>
        <div class="switch-group"><span>Объекты JSON</span><label class="switch"><input type="checkbox" id="border-switch" checked onchange="updateGeo()"><span class="slider"></span></label></div>
       
    </div>

    <div id="t-draw" class="tab-page">
        <h2>Рисование</h2>
        <button class="tool-btn active" id="tool-brush" onclick="setTool('brush')">Кисть</button>
        <button class="tool-btn" id="tool-arrow" onclick="setTool('arrow')">Стрелка</button>
        <button class="tool-btn" id="tool-circle" onclick="setTool('circle')">Круг</button>
        <button class="tool-btn" id="tool-rect" onclick="setTool('rect')">Квадрат</button>
        <input type="color" id="m-color" value="#c2b280" style="width:100%; height:40px; border:1px solid #333; background:none; margin:10px 0;">
        <button class="tool-btn" id="draw-btn" onclick="togglePaint()" style="background:var(--army-red); color:#fff; border:none; justify-content:center;">Включить рисование</button>
        <button class="tool-btn" onclick="clearCanvas()" style="margin-top:10px; justify-content:center;">Очистить слой</button>
    </div>

    <div id="t-don" class="tab-page">
        <h2>Поддержка проекта</h2>
        <p style="font-size: 13px; line-height: 1.5; color: #777; margin-bottom: 15px;">
             Поддержите Бугаза копеечкой.
        </p>
        
        <div class="support-card">
            <div style="font-size: 11px; color: var(--khaki); text-transform: uppercase; font-weight: bold;">Номер карты:</div>
            <div class="card-number-box" id="card-num">2200 7005 0856 7400</div>
           
        </div>
        
        <p style="font-size: 11px; color: #444; margin-top: 20px; text-align: center;">Спасибо за использование PolitMap :)</p>
    </div>
</div>

<div id="map-wrap">
    <canvas id="paint-canvas"></canvas>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.3, 37.5], 7);
    
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    

    function toggleLayers() {
        if(document.getElementById('sat-switch').checked) {
            map.removeLayer(darkTiles); esriSatellite.addTo(map); osmLabels.addTo(map);
        } else {
            map.removeLayer(esriSatellite); map.removeLayer(osmLabels); darkTiles.addTo(map);
        }
    }

    // ЛОГИКА ВКЛАДОК
    let currentActiveTab = 'map';
    function toggleTab(id) {
        const sidebar = document.getElementById('sidebar');
        const btn = document.getElementById('btn-' + id);
        
        if (currentActiveTab === id && !sidebar.classList.contains('collapsed')) {
            sidebar.classList.add('collapsed');
            btn.classList.remove('active');
        } else {
            sidebar.classList.remove('collapsed');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById('t-' + id).classList.add('active');
            currentActiveTab = id;
        }
        setTimeout(() => map.invalidateSize(), 300);
    }

    // КОПИРОВАНИЕ КАРТЫ
    function copyCard() {
        const num = document.getElementById('card-num').innerText;
        navigator.clipboard.writeText(num.replace(/\s/g, ''));
        const btn = document.querySelector('.copy-btn');
        const oldTxt = btn.innerText;
        btn.innerText = 'Скопировано!';
        btn.style.background = '#28a745';
        setTimeout(() => {
            btn.innerText = oldTxt;
            btn.style.background = 'var(--army-red)';
        }, 2000);
    }

    let geoJsonLayer;
    async function loadMapData() {
        try {
            const r = await fetch('data/map.json?v=' + Date.now());
            const data = await r.json();
            if(geoJsonLayer) map.removeLayer(geoJsonLayer);
            geoJsonLayer = L.geoJSON(data, {
                style: (f) => ({
                    fillColor: f.properties.color || "#8b0000", fillOpacity: 0.4,
                    color: document.getElementById('border-switch').checked ? (f.properties.color || "#8b0000") : "transparent", weight: 2
                }),
                pointToLayer: (f, ll) => L.marker(ll, { 
                    icon: L.divIcon({ className: '', html: '<div class="pulsating-dot"></div>', iconSize: [14,14], iconAnchor: [7,7] }) 
                }),
                onEachFeature: (f, l) => {
                    if(f.geometry.type === 'Point') {
                        l.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            l.bindTooltip(f.properties.name, { className: 'custom-tooltip', direction: 'top', offset: [0, -10] }).openTooltip();
                        });
                    }
                }
            }).addTo(map);
        } catch(e) {}
    }
    function updateGeo() { if(geoJsonLayer) geoJsonLayer.setStyle(() => ({ color: document.getElementById('border-switch').checked ? "inherit" : "transparent" })); }

    // РИСОВАЛКА
    const canvas = document.getElementById('paint-canvas'), ctx = canvas.getContext('2d');
    let isDrawing = false, currentTool = 'brush', snapshot, startX, startY;

    function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.addEventListener('resize', resize); resize();

    function togglePaint() {
        const active = canvas.classList.toggle('active');
        document.getElementById('draw-btn').innerText = active ? "Выключить" : "Включить рисование";
        if(active) { map.dragging.disable(); map.touchZoom.disable(); } 
        else { map.dragging.enable(); map.touchZoom.enable(); }
    }

    function setTool(t) {
        currentTool = t;
        document.querySelectorAll('#t-draw .tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tool-' + t).classList.add('active');
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    canvas.addEventListener('pointerdown', (e) => {
        if(!canvas.classList.contains('active')) return;
        isDrawing = true;
        const p = getPos(e); startX = p.x; startY = p.y;
        ctx.strokeStyle = document.getElementById('m-color').value;
        ctx.lineWidth = 3; ctx.lineCap = 'round';
        snapshot = ctx.getImageData(0,0, canvas.width, canvas.height);
        if(currentTool === 'brush') { ctx.beginPath(); ctx.moveTo(p.x, p.y); }
    });

    canvas.addEventListener('pointermove', (e) => {
        if(!isDrawing) return;
        const p = getPos(e);
        if(currentTool === 'brush') {
            ctx.lineTo(p.x, p.y); ctx.stroke();
        } else {
            ctx.putImageData(snapshot, 0, 0); ctx.beginPath();
            if(currentTool === 'arrow') {
                const a = Math.atan2(p.y - startY, p.x - startX);
                ctx.moveTo(startX, startY); ctx.lineTo(p.x, p.y);
                ctx.lineTo(p.x - 15 * Math.cos(a - Math.PI/6), p.y - 15 * Math.sin(a - Math.PI/6));
                ctx.moveTo(p.x, p.y); ctx.lineTo(p.x - 15 * Math.cos(a + Math.PI/6), p.y - 15 * Math.sin(a + Math.PI/6));
            } else if(currentTool === 'circle') {
                ctx.arc(startX, startY, Math.sqrt((p.x-startX)**2 + (p.y-startY)**2), 0, Math.PI*2);
            } else if(currentTool === 'rect') {
                ctx.rect(startX, startY, p.x - startX, p.y - startY);
            }
            ctx.stroke();
        }
    });

    window.addEventListener('pointerup', () => isDrawing = false);
    function clearCanvas() { ctx.clearRect(0,0, canvas.width, canvas.height); }

    loadMapData();
</script>
</body>
</html>
