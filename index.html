<<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PolitMap Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --army-red: #8b0000;
            --khaki: #c2b280;
            --sidebar-bg: #0d0d0d;
            --border-color: #222;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            color: #ccc;
        }

        /* –¢–ê–ë –ë–ê–† (–õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨) */
        #tab-bar {
            width: 60px;
            min-width: 60px;
            background: #111;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            z-index: 3001;
        }

        .tab-btn {
            width: 42px;
            height: 42px;
            color: #444;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 20px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab-btn svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .tab-btn.active {
            color: var(--khaki);
            background: #1a1e16;
            border: 1px solid #3b4634;
        }

        /* –°–ê–ô–î–ë–ê–† */
        #sidebar {
            width: 300px;
            min-width: 300px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
        }

        @media (max-width: 768px) {
            #sidebar {
                position: absolute;
                left: 60px;
                width: calc(100vw - 60px);
                height: 100%;
                transform: translateX(-110%);
                transition: 0.3s transform ease;
            }
            #sidebar.mobile-active { transform: translateX(0); }
        }

        .tab-content {
            display: none;
            padding: 25px 20px;
            height: 100%;
            overflow-y: auto;
        }

        .tab-content.active { display: block; }

        h2 {
            color: #fff;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 0 0 20px 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* –ö–ù–û–ü–ö–ò */
        .btn {
            width: 100%;
            padding: 12px;
            background: #151515;
            border: 1px solid #333;
            color: #888;
            margin-bottom: 8px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            transition: 0.2s;
        }

        .btn:hover { background: #1a1a1a; color: #fff; }
        .btn.active { border-color: var(--khaki); color: #fff; background: #1a1e16; }
        .btn-danger { color: #ff4444; border-color: #400; margin-top: 15px; justify-content: center; }

        /* –ö–ê–†–¢–ê */
        #map-wrap { position: relative; flex-grow: 1; height: 100vh; }
        #map { height: 100%; width: 100%; z-index: 1; background: #000; }
        
        #draw-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
            pointer-events: none;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        #draw-canvas.enabled { pointer-events: auto; cursor: crosshair; }

        /* –≠–õ–ï–ú–ï–ù–¢–´ –ö–ê–†–¢–´ */
        .pulsating-point {
            width: 12px;
            height: 12px;
            background: #ff3b3b;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff3b3b;
            border: 2px solid #fff;
        }

        .custom-tooltip {
            background: rgba(0,0,0,0.9);
            border: 1px solid var(--khaki);
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
        }

        /* –î–û–ù–ê–¢ */
        .donate-wrap {
            background: #0a0a0a;
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .card-number {
            font-family: monospace;
            color: var(--khaki);
            font-size: 18px;
            display: block;
            margin: 15px 0;
            padding: 10px;
            background: #000;
            border: 1px dashed #444;
        }
    </style>
</head>
<body>

<div id="tab-bar">
    <div class="tab-btn active" id="t-layers" onclick="setPage('layers')">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
    </div>
    <div class="tab-btn" id="t-draw" onclick="setPage('draw')">
        <svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
    </div>
    <div class="tab-btn" id="t-donate" onclick="setPage('donate')">
        <svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
    </div>
</div>

<div id="sidebar">
    <div id="page-layers" class="tab-content active">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
        <button class="btn" id="sat-toggle" onclick="toggleSat()">üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–π —Å–ª–æ–π</button>
        <button class="btn" onclick="fetchGeoData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≥–æ–Ω—ã</button>
    </div>

    <div id="page-draw" class="tab-content">
        <h2>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h2>
        <button class="btn active" id="btn-brush" onclick="updateTool('brush')">üñåÔ∏è –ö–∏—Å—Ç—å</button>
        <button class="btn" id="btn-arrow" onclick="updateTool('arrow')">‚ÜóÔ∏è –°—Ç—Ä–µ–ª–∫–∞</button>
        <button class="btn" id="btn-circle" onclick="updateTool('circle')">‚≠ï –ö—Ä—É–≥</button>
        <button class="btn" id="btn-rect" onclick="updateTool('rect')">üü¶ –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</button>
        
        <div style="margin: 15px 0;">
            <label style="font-size: 10px; color: #555; display: block; margin-bottom: 5px;">–¶–í–ï–¢</label>
            <input type="color" id="tool-color" value="#c2b280" style="width:100%; height:35px; border:1px solid #333; background:none; cursor:pointer;">
        </div>

        <button class="btn" id="main-draw-toggle" onclick="toggleDrawing()" style="background:#222; color:#fff; justify-content:center; font-weight:bold;">–í–ö–õ–Æ–ß–ò–¢–¨ –†–ò–°–û–í–ê–ù–ò–ï</button>
        <button class="btn btn-danger" onclick="wipeCanvas()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    </div>

    <div id="page-donate" class="tab-content">
        <h2>–†–µ–∫–≤–∏–∑–∏—Ç—ã</h2>
        <div class="donate-wrap">
            <span style="font-size: 10px; color: #444;">–ü–û–î–î–ï–†–ñ–ö–ê –ü–†–û–ï–ö–¢–ê</span>
            <span class="card-number" id="card-display">0000 0000 0000 0000</span>
            <button class="btn" onclick="doCopy()" style="justify-content:center; background:#1a1e16; color:#fff;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä</button>
        </div>
    </div>
</div>

<div id="map-wrap">
    <canvas id="draw-canvas"></canvas>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø LEAFLET ---
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.3, 37.5], 7);
    const tileDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    const tileSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    let isSatellite = false;
    function toggleSat() {
        isSatellite = !isSatellite;
        if(isSatellite) { map.removeLayer(tileDark); tileSat.addTo(map); }
        else { map.removeLayer(tileSat); tileDark.addTo(map); }
        document.getElementById('sat-toggle').classList.toggle('active', isSatellite);
    }

    // --- –õ–û–ì–ò–ö–ê –¢–ê–ë–û–í ---
    function setPage(id) {
        document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('t-' + id).classList.add('active');
        document.getElementById('page-' + id).classList.add('active');
        if(window.innerWidth <= 768) document.getElementById('sidebar').classList.add('mobile-active');
        setTimeout(() => map.invalidateSize(), 200);
    }

    // --- GEOJSON –ò –ü–û–õ–ò–ì–û–ù–´ ---
    let geoJsonLayer;
    async function fetchGeoData() {
        try {
            const res = await fetch('data/map.json?nocache=' + Date.now());
            const data = await res.json();
            if(geoJsonLayer) map.removeLayer(geoJsonLayer);
            geoJsonLayer = L.geoJSON(data, {
                style: (f) => ({
                    fillColor: f.properties.color || "#8b0000",
                    color: f.properties.color || "#8b0000",
                    weight: 2,
                    fillOpacity: 0.4
                }),
                pointToLayer: (f, ll) => L.marker(ll, {
                    icon: L.divIcon({ className: '', html: '<div class="pulsating-point"></div>', iconSize: [12,12], iconAnchor: [6,6] })
                }),
                onEachFeature: (f, layer) => {
                    if(f.properties.name) {
                        layer.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            if(layer.getTooltip()) layer.unbindTooltip();
                            else layer.bindTooltip(f.properties.name, { sticky: false, className: 'custom-tooltip' }).openTooltip();
                        });
                    }
                }
            }).addTo(map);
            if(geoJsonLayer.getBounds().isValid()) map.fitBounds(geoJsonLayer.getBounds());
        } catch(e) { console.error("Data error", e); }
    }

    // --- –†–ò–°–û–í–ê–õ–ö–ê (–ü–û–õ–ù–´–ô –î–í–ò–ñ–û–ö) ---
    const canvas = document.getElementById('draw-canvas'), ctx = canvas.getContext('2d');
    let active = false, drawing = false, tool = 'brush', snapshot, startX, startY;

    function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.onresize = resize; resize();

    function toggleDrawing() {
        active = !active;
        const btn = document.getElementById('main-draw-toggle');
        btn.innerText = active ? "–í–´–ö–õ–Æ–ß–ò–¢–¨" : "–í–ö–õ–Æ–ß–ò–¢–¨ –†–ò–°–û–í–ê–ù–ò–ï";
        btn.style.background = active ? "#8b0000" : "#222";
        canvas.classList.toggle('enabled', active);
        active ? map.dragging.disable() : map.dragging.enable();
    }

    function updateTool(t) {
        tool = t;
        document.querySelectorAll('#page-draw .btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + t).classList.add('active');
    }

    function getCoords(e) {
        const box = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - box.left, y: clientY - box.top };
    }

    function onStart(e) {
        if(!active) return;
        drawing = true;
        const p = getCoords(e); startX = p.x; startY = p.y;
        ctx.strokeStyle = document.getElementById('tool-color').value;
        ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
        if(tool === 'brush') { ctx.beginPath(); ctx.moveTo(startX, startY); }
    }

    function onMove(e) {
        if(!drawing) return;
        if(e.cancelable) e.preventDefault();
        const p = getCoords(e);
        if(tool === 'brush') {
            ctx.lineTo(p.x, p.y); ctx.stroke();
        } else {
            ctx.putImageData(snapshot, 0, 0);
            ctx.beginPath();
            if(tool === 'arrow') {
                const head = 15, angle = Math.atan2(p.y - startY, p.x - startX);
                ctx.moveTo(startX, startY); ctx.lineTo(p.x, p.y);
                ctx.lineTo(p.x - head * Math.cos(angle - Math.PI / 6), p.y - head * Math.sin(angle - Math.PI / 6));
                ctx.moveTo(p.x, p.y); ctx.lineTo(p.x - head * Math.cos(angle + Math.PI / 6), p.y - head * Math.sin(angle + Math.PI / 6));
            } else if(tool === 'circle') {
                ctx.arc(startX, startY, Math.sqrt((p.x-startX)**2 + (p.y-startY)**2), 0, Math.PI*2);
            } else if(tool === 'rect') {
                ctx.rect(startX, startY, p.x - startX, p.y - startY);
            }
            ctx.stroke();
        }
    }

    canvas.onmousedown = onStart;
    window.onmousemove = onMove;
    window.onmouseup = () => drawing = false;

    canvas.ontouchstart = (e) => { if(active) onStart(e); };
    canvas.ontouchmove = onMove;
    canvas.ontouchend = () => drawing = false;

    function wipeCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
    function doCopy() { navigator.clipboard.writeText(document.getElementById('card-display').innerText); alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); }

    fetchGeoData();
</script>
</body>
</html>
