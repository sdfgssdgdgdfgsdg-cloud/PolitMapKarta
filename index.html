<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PolitMap –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --army-red: #8b0000; --khaki: #c2b280; --sidebar-bg: #0d0d0d; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { background: #000; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; color: #ccc; }

        /* –¢–ê–ë-–ë–ê–† */
        #tab-bar { width: 60px; min-width: 60px; background: #111; border-right: 1px solid #222; display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 10005; }
        .tab-btn { width: 44px; height: 44px; color: #444; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 20px; border-radius: 8px; transition: 0.2s; pointer-events: auto; }
        .tab-btn.active { color: var(--khaki); background: #1a1e16; border: 1px solid #3b4634; }
        .tab-btn svg { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; }

        /* –°–ê–ô–î–ë–ê–† */
        #sidebar { width: 300px; background: var(--sidebar-bg); border-right: 1px solid #222; z-index: 10004; transition: 0.3s; position: relative; overflow: hidden; }
        #sidebar.collapsed { width: 0; border-right: none; }
        .tab-page { display: none; padding: 20px; width: 300px; height: 100%; overflow-y: auto; }
        .tab-page.active { display: block; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .switch-group { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #151515; border-radius: 6px; margin-bottom: 8px; border: 1px solid #222; font-size: 13px; cursor: pointer; }
        .tool-btn { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #333; color: #888; cursor: pointer; border-radius: 4px; font-weight: bold; margin-top: 8px; text-transform: uppercase; font-size: 10px; }
        .tool-btn.active { border-color: var(--khaki); color: #fff; background: #1a1e16; }
        .main-action { background: var(--army-red) !important; color: #fff !important; border: none !important; margin-top: 15px; }

        input[type=range] { width: 100%; accent-color: var(--army-red); cursor: pointer; }
        input[type=color] { width: 40px; height: 20px; border: none; background: none; cursor: pointer; }

        /* –ö–ê–†–¢–ê */
        #map-wrap { position: relative; flex-grow: 1; height: 100%; z-index: 1; }
        #map { height: 100%; width: 100%; z-index: 10; background: #050505; }
        #paint-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; pointer-events: none; }
        #paint-canvas.active { pointer-events: auto; cursor: crosshair; }

        /* –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ */
        .switch { position: relative; width: 34px; height: 18px; pointer-events: none; }
        .switch input { display: none; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #333; border-radius: 20px; transition: 0.4s; }
        .slider:before { content: ""; position: absolute; height: 12px; width: 12px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.4s; }
        input:checked + .slider { background: #44ff44; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* –ü–£–õ–¨–°–ê–¶–ò–Ø */
        .dot-container { display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; }
        .pulsating-dot { width: 8px; height: 8px; background: #ff4444; border-radius: 50%; position: relative; box-shadow: 0 0 10px #ff4444; }
        .pulsating-dot::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 8px; height: 8px;
            margin: -4px 0 0 -4px; border-radius: 50%; border: 2px solid #ff4444;
            animation: pulsate 1.8s ease-out infinite; box-sizing: border-box;
        }
        @keyframes pulsate { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(5); opacity: 0; } }

        .custom-tooltip { background: #000 !important; border: 1px solid var(--khaki) !important; color: #fff !important; font-size: 11px; padding: 4px 8px; }

        .support-card { background: #111; border: 1px solid #222; padding: 15px; border-radius: 8px; text-align: center; }
        .card-number { font-family: monospace; font-size: 15px; color: #fff; display: block; background: #000; padding: 10px; border: 1px dashed var(--army-red); margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="tab-bar">
    <div class="tab-btn active" id="btn-map" onclick="toggleTab('map')"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg></div>
    <div class="tab-btn" id="btn-draw" onclick="toggleTab('draw')"><svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></div>
    <div class="tab-btn" id="btn-info" onclick="toggleTab('info')"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></div>
    <div class="tab-btn" id="btn-don" onclick="toggleTab('don')"><svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg></div>
</div>

<div id="sidebar">
    <div id="t-map" class="tab-page active">
        <h2 style="font-size: 11px; letter-spacing: 2px; margin-bottom: 15px;">–ö–ê–†–¢–ê</h2>
        <div class="switch-group" onclick="toggleCheck('sat-in')">
            <span>–°–ø—É—Ç–Ω–∏–∫</span>
            <label class="switch"><input type="checkbox" id="sat-in" onchange="toggleLayers()"><span class="slider"></span></label>
        </div>
        <div class="switch-group" onclick="toggleCheck('obj-in')">
            <span>–¶–≤–µ—Ç–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã —Ñ—Ä–æ–Ω—Ç–∞</span>
            <label class="switch"><input type="checkbox" id="obj-in" checked onchange="updateGeo()"><span class="slider"></span></label>
        </div>
        <button class="tool-btn" onclick="loadMap()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>

    <div id="t-draw" class="tab-page">
        <h2 style="font-size: 11px; letter-spacing: 2px; margin-bottom: 15px;">–ò–ù–°–¢–†–£–ú–ï–ù–¢–´</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
            <button class="tool-btn active" id="tool-brush" onclick="setTool('brush')">–ö–∏—Å—Ç—å</button>
            <button class="tool-btn" id="tool-arrow" onclick="setTool('arrow')">–°—Ç—Ä–µ–ª–∞</button>
            <button class="tool-btn" id="tool-circle" onclick="setTool('circle')">–ö—Ä—É–≥</button>
        </div>
        <div class="switch-group" style="flex-direction: column; align-items: flex-start; margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; width: 100%;"><span>–¢–æ–ª—â–∏–Ω–∞</span><span id="brush-val">3px</span></div>
            <input type="range" id="brush-size" min="1" max="20" value="3" oninput="updateBrushVal(this.value)">
        </div>
        <div class="switch-group"><span>–¶–≤–µ—Ç</span><input type="color" id="m-color" value="#c2b280"></div>
        <button class="tool-btn main-action" id="draw-btn" onclick="togglePaint()">–í–∫–ª—é—á–∏—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ</button>
        <button class="tool-btn" onclick="clearCanvas()">‚ùå –°—Ç–µ—Ä–µ—Ç—å –≤—Å—ë</button>
    </div>

    <div id="t-info" class="tab-page">
        <h2 style="font-size: 11px; letter-spacing: 2px; margin-bottom: 15px;">–ò–ù–§–û</h2>
        <p style="font-size: 13px; color: #888;">–≠—Ç–æ—Ç —Å–∞–π—Ç —Å–¥–µ–ª–∞–Ω –Ω–∞ –∫–æ–ª–µ–Ω–∫–µ, –∏ —Ç–æ —Å–∞–π—Ç —Å–æ–∑–¥–∞–Ω –Ω–µ –ë—É–≥–∞–∑–æ–º, –∞ –Ω–µ–π—Ä–æ–Ω–∫–æ–π Gemini, —Å–∫–≤–æ–∑—å –ø–æ—Ç –∏ –∫—Ä–æ–≤—å –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ-—Ç–æ.</p>
    </div>

    <div id="t-don" class="tab-page">
        <h2 style="font-size: 11px; letter-spacing: 2px; margin-bottom: 15px;">–ü–û–î–î–ï–†–ñ–ö–ê –ë–£–ì–ê–ó–ê</h2>
        <div class="support-card">
            <span class="card-number" id="card-val">2200 7005 0856 7400</span>
        </div>
    </div>
</div>

<div id="map-wrap">
    <canvas id="paint-canvas"></canvas>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png');
    
    const map = L.map('map', { zoomControl: false, attributionControl: false, layers: [dark] }).setView([48.3, 37.5], 7);

    const fillGroup = L.layerGroup().addTo(map);   
    const borderGroup = L.layerGroup().addTo(map); 
    const pointsGroup = L.layerGroup().addTo(map); 

    function toggleLayers() {
        const isSat = document.getElementById('sat-in').checked;
        if(isSat) { map.removeLayer(dark); map.addLayer(esri); map.addLayer(labels); }
        else { map.removeLayer(esri); map.removeLayer(labels); map.addLayer(dark); }
    }

    async function loadMap() {
        try {
            const res = await fetch('data/map.json?v=' + Date.now());
            const data = await res.json();
            fillGroup.clearLayers(); borderGroup.clearLayers(); pointsGroup.clearLayers();

            L.geoJSON(data, {
                pointToLayer: (f, ll) => {
                    const m = L.marker(ll, { icon: L.divIcon({ className: '', html: '<div class="dot-container"><div class="pulsating-dot"></div></div>', iconSize: [24,24], iconAnchor: [12,12] }) });
                    m.bindTooltip(f.properties.name || "–û–±—ä–µ–∫—Ç", { className: 'custom-tooltip', direction: 'top', offset: [0, -10] });
                    m.addTo(pointsGroup); return m;
                },
                style: (f) => {
                    if (f.geometry.type !== 'Point') {
                        const rawColor = f.properties.fill || f.properties.stroke || f.properties.color || "#8b0000";
                        L.geoJSON(f, { style: { color: rawColor, weight: 0, fillOpacity: 0.25, interactive: false } }).addTo(fillGroup);
                        L.geoJSON(f, { style: { color: rawColor, weight: 3, fillOpacity: 0, interactive: false } }).addTo(borderGroup);
                    }
                }
            });
            updateGeo();
        } catch(e) { console.log("JSON Error"); }
    }

    function updateGeo() {
        const showBorder = document.getElementById('obj-in').checked;
        showBorder ? map.addLayer(borderGroup) : map.removeLayer(borderGroup);
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –¢–ê–ë–û–í
    function toggleTab(id) {
        const sidebar = document.getElementById('sidebar');
        const btn = document.getElementById('btn-' + id);
        const page = document.getElementById('t-' + id);

        // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä
        if (btn.classList.contains('active') && !sidebar.classList.contains('collapsed')) {
            sidebar.classList.add('collapsed');
            btn.classList.remove('active');
        } else {
            // –ò–Ω–∞—á–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º/–ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º
            sidebar.classList.remove('collapsed');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            
            btn.classList.add('active');
            page.classList.add('active');
        }
        
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => map.invalidateSize(), 300);
    }

    function toggleCheck(id) { 
        const el = document.getElementById(id); 
        el.checked = !el.checked; 
        el.dispatchEvent(new Event('change')); 
    }

    function updateBrushVal(v) { document.getElementById('brush-val').innerText = v + 'px'; }

    function copyCard() {
        navigator.clipboard.writeText(document.getElementById('card-val').innerText.replace(/\s/g, ''));
        alert("–ù–æ–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
    }

    // –†–ò–°–û–í–ê–ù–ò–ï
    const canvas = document.getElementById('paint-canvas'), ctx = canvas.getContext('2d');
    let drawing = false, currentTool = 'brush', snapshot, startX, startY;

    function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.addEventListener('resize', resize); resize();

    function setTool(t) {
        currentTool = t;
        document.querySelectorAll('#t-draw .tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tool-' + t).classList.add('active');
    }

    function togglePaint() {
        const active = canvas.classList.toggle('active');
        document.getElementById('draw-btn').innerText = active ? "–í–´–ö–õ–Æ–ß–ò–¢–¨" : "–í–ö–õ–Æ–ß–ò–¢–¨ –†–ò–°–û–í–ê–ù–ò–ï";
        active ? (map.dragging.disable(), map.touchZoom.disable()) : (map.dragging.enable(), map.touchZoom.enable());
    }

    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    canvas.addEventListener('pointerdown', (e) => { 
        if(!canvas.classList.contains('active')) return;
        drawing = true; startX = e.offsetX; startY = e.offsetY;
        ctx.strokeStyle = document.getElementById('m-color').value;
        ctx.lineWidth = document.getElementById('brush-size').value;
        ctx.lineCap = 'round';
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
        if(currentTool === 'brush') { ctx.beginPath(); ctx.moveTo(startX, startY); }
    });

    canvas.addEventListener('pointermove', (e) => { 
        if(!drawing) return;
        if(currentTool === 'brush') { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }
        else {
            ctx.putImageData(snapshot, 0, 0); ctx.beginPath();
            if(currentTool === 'circle') {
                ctx.arc(startX, startY, Math.sqrt((e.offsetX-startX)**2 + (e.offsetY-startY)**2), 0, Math.PI*2);
            } else if(currentTool === 'arrow') {
                const angle = Math.atan2(e.offsetY - startY, e.offsetX - startX);
                const s = ctx.lineWidth * 3 + 10;
                ctx.moveTo(startX, startY); ctx.lineTo(e.offsetX, e.offsetY);
                ctx.lineTo(e.offsetX - s * Math.cos(angle - Math.PI/6), e.offsetY - s * Math.sin(angle - Math.PI/6));
                ctx.moveTo(e.offsetX, e.offsetY);
                ctx.lineTo(e.offsetX - s * Math.cos(angle + Math.PI/6), e.offsetY - s * Math.sin(angle + Math.PI/6));
            }
            ctx.stroke();
        }
    });

    window.addEventListener('pointerup', () => drawing = false);
    loadMap();
</script>
</body>
</html>

