<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PolitMap | Tactical Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --army-red: #8b0000; --khaki: #c2b280; --sidebar: #0d0d0d; --border: #222; }
        * { box-sizing: border-box; }
        body { margin: 0; background: #000; font-family: "Segoe UI", sans-serif; display: flex; color: #777; overflow: hidden; height: 100vh; }

        /* ИНТЕРФЕЙС ПАНЕЛЕЙ */
        #tab-bar { width: 50px; min-width: 50px; height: 100vh; background: #111; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 15px; z-index: 3001; }
        .tab-btn { width: 38px; height: 38px; color: #444; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 15px; border-radius: 6px; transition: 0.2s; }
        .tab-btn.active { color: var(--khaki); background: #2a2f24; border: 1px solid #3b4634; }
        .tab-btn svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; }

        #sidebar { width: 280px; height: 100vh; background: var(--sidebar); border-right: 1px solid var(--border); z-index: 3000; transition: transform 0.3s ease; overflow-y: auto; }
        #sidebar.collapsed { transform: translateX(-280px); width: 0; margin-right: -50px; }

        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 50px; width: calc(100vw - 50px); transform: translateX(-110%); }
            #sidebar.active { transform: translateX(0); }
        }

        .tab-page { display: none; padding: 20px; }
        .tab-page.active { display: block; }
        .header-title { font-size: 13px; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid #222; padding-bottom: 10px; margin-bottom: 20px; color: #fff; }

        /* КНОПКИ И ПЕРЕКЛЮЧАТЕЛИ */
        .item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; color: #ccc; font-size: 14px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #222; transition: .3s; border-radius: 20px; border: 1px solid #333; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background: #555; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background: #3b4634; border-color: var(--khaki); }
        input:checked + .slider:before { transform: translateX(20px); background: var(--khaki); }

        .control-group { margin-bottom: 20px; padding: 12px; background: #111; border-radius: 6px; border: 1px solid #1a1a1a; }
        .tool-btn { width: 100%; padding: 12px; background: #151515; border: 1px solid #222; color: #777; display: flex; align-items: center; gap: 10px; margin-bottom: 6px; cursor: pointer; border-radius: 4px; font-size: 13px; transition: 0.2s; }
        .tool-btn svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2; }
        .tool-btn.active { border-color: var(--khaki); color: #fff; background: #1a1e16; }
        
        /* КАРТА И ХОЛСТ РИСОВАНИЯ */
        #map-container { position: relative; flex-grow: 1; height: 100vh; background: #000; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        #paint-canvas { 
            position: absolute; 
            top: 0; left: 0; 
            z-index: 1000; 
            pointer-events: none; 
            width: 100%; height: 100%;
            touch-action: none; 
        }
        #paint-canvas.active { pointer-events: auto; cursor: crosshair; }

        /* ТОЧКИ */
        .dot-container { background: transparent !important; border: none !important; }
        .pulsating-dot { width: 12px; height: 12px; background: #ff3b3b; border-radius: 50%; box-shadow: 0 0 12px #ff3b3b; position: relative; }
        .pulsating-dot::after { content: ''; position: absolute; top: -6px; left: -6px; right: -6px; bottom: -6px; border: 2px solid #ff3b3b; border-radius: 50%; animation: pulse-wave 1.5s ease-out infinite; }
        @keyframes pulse-wave { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
    </style>
</head>
<body>

<div id="tab-bar">
    <div id="btn-layers" class="tab-btn active" onclick="handleTab('layers')"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg></div>
    <div id="btn-draw" class="tab-btn" onclick="handleTab('draw')"><svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></div>
    <div id="btn-info" class="tab-btn" onclick="handleTab('info')"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></div>
</div>

<div id="sidebar">
    <div id="layers" class="tab-page active">
        <div class="header-title">Карта</div>
        <div class="item"><span>Спутник + Границы</span><label class="switch"><input type="checkbox" id="satToggle" onchange="toggleSatellite()"><span class="slider"></span></label></div>
        <div class="item"><span>Слои данных</span><label class="switch"><input type="checkbox" checked id="layerToggle" onchange="toggleLayer('main')"><span class="slider"></span></label></div>
        <div class="item"><span>Границы (JSON)</span><label class="switch"><input type="checkbox" checked id="borderToggle" onchange="updateStyles()"><span class="slider"></span></label></div>
    </div>
    <div id="draw" class="tab-page">
        <div class="header-title">Рисовалка</div>
        <div class="control-group">
            <button class="tool-btn active" onclick="setTool('brush', this)"><svg viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3zM18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path></svg> Кисть</button>
            <button class="tool-btn" onclick="setTool('rect', this)"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg> Квадрат</button>
            <button class="tool-btn" onclick="setTool('circle', this)"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg> Круг</button>
            <button class="tool-btn" onclick="setTool('arrow', this)"><svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"></path></svg> Стрелка</button>
        </div>
        <div class="control-group">
            <input type="color" id="paint-color" value="#c2b280" style="width:100%; height:30px; border:none; background:none; cursor:pointer;">
        </div>
        <button class="tool-btn" onclick="togglePaintMode()" id="toggle-paint-btn" style="justify-content: center; background: #222; color: #fff;">ВКЛЮЧИТЬ РИСОВАНИЕ</button>
        <button class="tool-btn" onclick="clearCanvas()" style="color:#ff4444; margin-top: 10px; justify-content: center; border-color: #400;">Очистить всё</button>
    </div>
    <div id="info" class="tab-page">
        <div class="header-title">Инфо</div>
        <p style="font-size: 13px;"><b>PolitMap v1.7 FINAL</b><br><br>Если не рисует на мобильном: обновите страницу 3 раза или очистите кэш.</p>
    </div>
</div>

<div id="map-container">
    <canvas id="paint-canvas"></canvas>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    const satTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const satLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}');

    const map = L.map('map', { attributionControl: false, zoomControl: false, tap: false }).setView([48.3, 37.5], 7);
    darkTiles.addTo(map);

    let mainGeoLayer, layers = { main: L.layerGroup().addTo(map) };
    const canvas = document.getElementById('paint-canvas'), ctx = canvas.getContext('2d');
    let isPaintingMode = false, isDrawing = false, tool = 'brush', startX, startY, snapshot;

    function toggleSatellite() {
        if (document.getElementById('satToggle').checked) {
            map.removeLayer(darkTiles); satTiles.addTo(map); satLabels.addTo(map);
        } else {
            map.removeLayer(satTiles); map.removeLayer(satLabels); darkTiles.addTo(map);
        }
    }

    function handleTab(id) {
        const sb = document.getElementById('sidebar'), btn = document.getElementById('btn-' + id);
        if (btn.classList.contains('active')) {
            sb.classList.remove('active'); sb.classList.add('collapsed'); btn.classList.remove('active');
        } else {
            sb.classList.add('active'); sb.classList.remove('collapsed');
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active'); btn.classList.add('active');
        }
        setTimeout(() => { map.invalidateSize(); resizeCanvas(); }, 300);
    }

    function togglePaintMode() {
        isPaintingMode = !isPaintingMode;
        const btn = document.getElementById('toggle-paint-btn');
        if (isPaintingMode) {
            btn.innerText = "ВЫКЛЮЧИТЬ РИСОВАНИЕ";
            btn.style.background = "#8b0000"; // Кнопка станет красной!
            canvas.classList.add('active');
            map.dragging.disable(); map.touchZoom.disable();
        } else {
            btn.innerText = "ВКЛЮЧИТЬ РИСОВАНИЕ";
            btn.style.background = "#222";
            canvas.classList.remove('active');
            map.dragging.enable(); map.touchZoom.enable();
        }
    }

    function setTool(t, btn) {
        tool = t;
        document.querySelectorAll('#draw .tool-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function resizeCanvas() { 
        canvas.width = canvas.parentElement.clientWidth; 
        canvas.height = canvas.parentElement.clientHeight; 
    }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        let x, y;
        if (e.touches && e.touches[0]) {
            x = e.touches[0].clientX - rect.left;
            y = e.touches[0].clientY - rect.top;
        } else {
            x = e.clientX - rect.left; y = e.clientY - rect.top;
        }
        return { x, y };
    }

    function startDraw(e) {
        if (!isPaintingMode) return;
        isDrawing = true; const pos = getPos(e);
        startX = pos.x; startY = pos.y;
        ctx.strokeStyle = document.getElementById('paint-color').value;
        ctx.lineWidth = 3; ctx.lineCap = 'round';
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
        if (tool === 'brush') { ctx.beginPath(); ctx.moveTo(startX, startY); }
    }

    function moveDraw(e) {
        if (!isDrawing) return;
        const pos = getPos(e);
        if (tool !== 'brush') ctx.putImageData(snapshot, 0, 0);
        if (tool === 'brush') { ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
        else if (tool === 'rect') ctx.strokeRect(startX, startY, pos.x - startX, pos.y - startY);
        else if (tool === 'circle') {
            ctx.beginPath(); let r = Math.sqrt(Math.pow(startX - pos.x, 2) + Math.pow(startY - pos.y, 2));
            ctx.arc(startX, startY, r, 0, 2 * Math.PI); ctx.stroke();
        } else if (tool === 'arrow') drawArrow(startX, startY, pos.x, pos.y);
    }

    function stopDraw() { isDrawing = false; ctx.beginPath(); }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', moveDraw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('touchstart', (e) => { if (isPaintingMode) { startDraw(e); e.preventDefault(); } }, { passive: false });
    canvas.addEventListener('touchmove', (e) => { if (isPaintingMode) { moveDraw(e); e.preventDefault(); } }, { passive: false });
    canvas.addEventListener('touchend', stopDraw);

    function drawArrow(x1, y1, x2, y2) {
        const headlen = 15; const angle = Math.atan2(y2 - y1, x2 - x1);
        ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
        ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI/6), y2 - headlen * Math.sin(angle - Math.PI/6));
        ctx.moveTo(x2, y2); ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI/6), y2 - headlen * Math.sin(angle + Math.PI/6));
        ctx.stroke();
    }

    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    async function loadData() {
        try {
            const res = await fetch('data/map.json?v=' + Date.now());
            const data = await res.json();
            layers.main.clearLayers();
            mainGeoLayer = L.geoJSON(data, {
                style: (f) => ({ 
                    fillColor: f.properties.color || "#8b0000", color: f.properties.color || "#8b0000",
                    weight: document.getElementById('borderToggle').checked ? 2 : 0,
                    fillOpacity: f.properties.fillOpacity || 0.4,
                    opacity: document.getElementById('borderToggle').checked ? 1 : 0
                }),
                pointToLayer: (f, latlng) => L.marker(latlng, { icon: pulsingIcon }),
                onEachFeature: (f, layer) => {
                    if (f.geometry.type === "Point" && f.properties.name) {
                        layer.on('click', (e) => {
                            if (layer.getTooltip()) { layer.closeTooltip(); layer.unbindTooltip(); }
                            else { layer.bindTooltip(f.properties.name, { permanent: true, direction: 'top', offset: [0, -10] }).openTooltip(); }
                            L.DomEvent.stopPropagation(e);
                        });
                    }
                }
            }).addTo(layers.main);
        } catch(e) { console.error("JSON Error"); }
    }

    function updateStyles() { if (mainGeoLayer) mainGeoLayer.setStyle((f) => ({ weight: document.getElementById('borderToggle').checked ? 2 : 0, opacity: document.getElementById('borderToggle').checked ? 1 : 0 })); }
    function toggleLayer(k) { document.getElementById('layerToggle').checked ? map.addLayer(layers[k]) : map.removeLayer(layers[k]); }

    loadData();
</script>
</body>
</html>
