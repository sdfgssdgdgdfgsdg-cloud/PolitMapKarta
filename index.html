<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PolitMap | Tactical Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --army-red: #8b0000;
            --khaki: #c2b280;
            --sidebar-bg: #0d0d0d;
            --border-color: #222;
            --active-bg: #1a1e16;
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; 
            display: flex; height: 100vh; overflow: hidden; color: #ccc; 
        }

        /* –¢–ê–ë –ë–ê–† */
        #tab-bar { 
            width: 60px; min-width: 60px; background: #111; border-right: 1px solid var(--border-color); 
            display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 3001; 
        }
        .tab-btn { 
            width: 44px; height: 44px; color: #444; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; margin-bottom: 20px; border-radius: 8px; transition: 0.2s; 
        }
        .tab-btn svg { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }
        .tab-btn.active { color: var(--khaki); background: var(--active-bg); border: 1px solid #3b4634; }

        /* –°–ê–ô–î–ë–ê–† */
        #sidebar { 
            width: 300px; min-width: 300px; background: var(--sidebar-bg); 
            border-right: 1px solid var(--border-color); z-index: 3000; display: flex; flex-direction: column; 
        }
        .tab-page { display: none; padding: 25px 20px; height: 100%; overflow-y: auto; }
        .tab-page.active { display: block; }

        h2 { 
            color: #fff; font-size: 13px; text-transform: uppercase; letter-spacing: 2px; 
            margin: 0 0 20px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; 
        }

        /* –ü–û–õ–ó–£–ù–ö–ò */
        .switch-group { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; padding: 12px; background: #151515; border-radius: 6px; border: 1px solid #222; 
        }
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: #333; transition: .4s; border-radius: 22px; 
        }
        .slider:before { 
            position: absolute; content: ""; height: 16px; width: 16px; 
            left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; 
        }
        input:checked + .slider { background-color: var(--army-red); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* –ö–ù–û–ü–ö–ò –° SVG */
        .tool-btn { 
            width: 100%; padding: 12px; background: #151515; border: 1px solid #333; 
            color: #888; margin-bottom: 8px; cursor: pointer; border-radius: 4px; 
            display: flex; align-items: center; gap: 12px; font-size: 13px; transition: 0.2s;
        }
        .tool-btn svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; }
        .tool-btn.active { border-color: var(--khaki); color: #fff; background: var(--active-bg); }
        .tool-btn.danger { color: #ff4444; border-color: #400; justify-content: center; margin-top: 15px; }

        /* –ö–ê–†–¢–ê */
        #map-wrap { position: relative; flex-grow: 1; height: 100vh; }
        #map { height: 100%; width: 100%; z-index: 1; background: #000; }
        #paint-canvas { 
            position: absolute; top: 0; left: 0; z-index: 1000; pointer-events: none; 
            width: 100%; height: 100%; touch-action: none; 
        }
        #paint-canvas.active { pointer-events: auto; cursor: crosshair; }

        /* –ú–ï–†–¶–ê–Æ–©–ê–Ø –¢–û–ß–ö–ê */
        .pulsating-dot { 
            width: 12px; height: 12px; background: #ff3b3b; border-radius: 50%; 
            border: 2px solid #fff; animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.7; box-shadow: 0 0 0 0 rgba(255, 59, 59, 0.7); }
            70% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 0 10px rgba(255, 59, 59, 0); }
            100% { transform: scale(0.9); opacity: 0.7; box-shadow: 0 0 0 0 rgba(255, 59, 59, 0); }
        }

        .leaflet-tooltip-custom {
            background: rgba(0,0,0,0.9) !important;
            border: 1px solid var(--khaki) !important;
            color: #fff !important; font-weight: bold; padding: 4px 8px;
        }
    </style>
</head>
<body>

<div id="tab-bar">
    <div class="tab-btn active" id="b-map" onclick="setTab('map')"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg></div>
    <div class="tab-btn" id="b-draw" onclick="setTab('draw')"><svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></div>
    <div class="tab-btn" id="b-don" onclick="setTab('don')"><svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg></div>
</div>

<div id="sidebar">
    <div id="t-map" class="tab-page active">
        <h2>–ö–∞—Ä—Ç–∞</h2>
        <div class="switch-group">
            <span class="switch-label">–°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–π —Å–ª–æ–π</span>
            <label class="switch"><input type="checkbox" id="sat-switch" onchange="toggleSat()"><span class="slider"></span></label>
        </div>
        <div class="switch-group">
            <span class="switch-label">–ì—Ä–∞–Ω–∏—Ü—ã –æ–±—ä–µ–∫—Ç–æ–≤</span>
            <label class="switch"><input type="checkbox" id="border-switch" checked onchange="updateGeoStyles()"><span class="slider"></span></label>
        </div>
        <button class="tool-btn" onclick="loadMapData()">
            <svg viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        </button>
    </div>

    <div id="t-draw" class="tab-page">
        <h2>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h2>
        <button class="tool-btn active" id="tool-brush" onclick="setTool('brush')">
            <svg viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3zM18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path></svg>
            –ö–∏—Å—Ç—å
        </button>
        <button class="tool-btn" id="tool-arrow" onclick="setTool('arrow')">
            <svg viewBox="0 0 24 24"><line x1="5" y1="19" x2="19" y2="5"></line><polyline points="12 5 19 5 19 12"></polyline></svg>
            –°—Ç—Ä–µ–ª–∫–∞
        </button>
        <button class="tool-btn" id="tool-circle" onclick="setTool('circle')">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg>
            –ö—Ä—É–≥
        </button>
        <button class="tool-btn" id="tool-rect" onclick="setTool('rect')">
            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
            –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
        </button>
        <input type="color" id="m-color" value="#c2b280" style="width:100%; height:35px; border:1px solid #333; background:none; cursor:pointer; margin: 15px 0;">
        <button class="tool-btn" id="draw-btn" onclick="togglePaintMode()" style="background:#222; color:#fff; justify-content:center; font-weight:bold;">–í–ö–õ–Æ–ß–ò–¢–¨ –†–ï–ñ–ò–ú</button>
        <button class="tool-btn danger" onclick="clearCanvas()">–£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
    </div>

    <div id="t-don" class="tab-page">
        <h2>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
        <div style="background:#0a0a0a; padding:20px; border-radius:8px; border:1px solid #222; text-align:center;">
            <span style="font-size:10px; color:#444;">HOMEP –ö–ê–†–¢–´</span>
            <span style="display:block; font-family:monospace; color:var(--khaki); font-size:18px; margin:15px 0;" id="card-n">0000 0000 0000 0000</span>
            <button class="tool-btn" onclick="copyCard()" style="justify-content:center; background:#1a1e16; color:#fff;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä</button>
        </div>
    </div>
</div>

<div id="map-wrap">
    <canvas id="paint-canvas"></canvas>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.3, 37.5], 7);
    
    // –°–õ–û–ò
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    const satTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const hybridBorders = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png'); // –ì—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Å–ø—É—Ç–Ω–∏–∫–∞

    darkTiles.addTo(map);

    function toggleSat() {
        const isSat = document.getElementById('sat-switch').checked;
        if(isSat) {
            map.removeLayer(darkTiles);
            satTiles.addTo(map);
            hybridBorders.addTo(map); // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–≤–µ—Ä—Ö —Å–ø—É—Ç–Ω–∏–∫–∞
        } else {
            map.removeLayer(satTiles);
            map.removeLayer(hybridBorders);
            darkTiles.addTo(map);
        }
    }

    function setTab(id) {
        document.querySelectorAll('.tab-btn, .tab-page').forEach(el => el.classList.remove('active'));
        document.getElementById('b-' + id).classList.add('active');
        document.getElementById('t-' + id).classList.add('active');
        setTimeout(() => map.invalidateSize(), 200);
    }

    let geoJsonLayer;
    async function loadMapData() {
        try {
            const r = await fetch('data/map.json?nocache=' + Date.now());
            const data = await r.json();
            if(geoJsonLayer) map.removeLayer(geoJsonLayer);
            geoJsonLayer = L.geoJSON(data, {
                style: getFeatureStyle,
                pointToLayer: (f, ll) => L.marker(ll, { 
                    icon: L.divIcon({ className: '', html: '<div class="pulsating-dot"></div>', iconSize: [12,12], iconAnchor: [6,6] }) 
                }),
                onEachFeature: (f, l) => {
                    if(f.properties.name && f.geometry.type === 'Point') {
                        // –¢–û–õ–¨–ö–û –ü–û –ö–õ–ò–ö–£
                        l.bindTooltip(f.properties.name, { 
                            className: 'leaflet-tooltip-custom', 
                            direction: 'top', 
                            offset: [0, -10],
                            sticky: false 
                        });
                        l.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            l.openTooltip();
                        });
                    }
                }
            }).addTo(map);
        } catch(e) {}
    }

    function getFeatureStyle(f) {
        const hasBorder = document.getElementById('border-switch').checked;
        return {
            fillColor: f.properties.color || "#8b0000",
            fillOpacity: 0.4,
            color: hasBorder ? (f.properties.color || "#8b0000") : "transparent",
            weight: hasBorder ? 2 : 0
        };
    }

    function updateGeoStyles() { if(geoJsonLayer) geoJsonLayer.setStyle(getFeatureStyle); }

    // --- –†–ò–°–û–í–ê–õ–ö–ê ---
    const canvas = document.getElementById('paint-canvas'), ctx = canvas.getContext('2d');
    let isEnabled = false, isDrawing = false, currentTool = 'brush', snapshot, startX, startY;

    function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.onresize = resize; resize();

    function togglePaintMode() {
        isEnabled = !isEnabled;
        document.getElementById('draw-btn').innerText = isEnabled ? "–í–´–ö–õ–Æ–ß–ò–¢–¨" : "–í–ö–õ–Æ–ß–ò–¢–¨ –†–ï–ñ–ò–ú";
        canvas.classList.toggle('active', isEnabled);
        isEnabled ? map.dragging.disable() : map.dragging.enable();
    }

    function setTool(t) {
        currentTool = t;
        document.querySelectorAll('#t-draw .tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tool-' + t).classList.add('active');
    }

    function getCoords(e) {
        const r = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - r.left, y: clientY - r.top };
    }

    canvas.onmousedown = canvas.ontouchstart = (e) => {
        if(!isEnabled) return;
        isDrawing = true;
        const p = getCoords(e); startX = p.x; startY = p.y;
        ctx.strokeStyle = document.getElementById('m-color').value;
        ctx.lineWidth = 3; ctx.lineCap = 'round';
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
        if(currentTool === 'brush') { ctx.beginPath(); ctx.moveTo(startX, startY); }
    };

    window.onmousemove = window.ontouchmove = (e) => {
        if(!isDrawing) return;
        if(e.cancelable) e.preventDefault();
        const p = getCoords(e);
        if(currentTool === 'brush') { ctx.lineTo(p.x, p.y); ctx.stroke(); }
        else {
            ctx.putImageData(snapshot, 0, 0); ctx.beginPath();
            if(currentTool === 'arrow') {
                const h = 15, a = Math.atan2(p.y - startY, p.x - startX);
                ctx.moveTo(startX, startY); ctx.lineTo(p.x, p.y);
                ctx.lineTo(p.x - h * Math.cos(a - Math.PI/6), p.y - h * Math.sin(a - Math.PI/6));
                ctx.moveTo(p.x, p.y); ctx.lineTo(p.x - h * Math.cos(a + Math.PI/6), p.y - h * Math.sin(a + Math.PI/6));
            } else if(currentTool === 'circle') {
                ctx.arc(startX, startY, Math.sqrt((p.x-startX)**2 + (p.y-startY)**2), 0, Math.PI*2);
            } else if(currentTool === 'rect') {
                ctx.rect(startX, startY, p.x - startX, p.y - startY);
            }
            ctx.stroke();
        }
    };

    window.onmouseup = window.ontouchend = () => isDrawing = false;
    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
    function copyCard() { navigator.clipboard.writeText(document.getElementById('card-n').innerText); alert("OK"); }

    loadMapData();
</script>
</body>
</html>
