<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PolitMap | Tactical Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --army-red: #8b0000; --khaki: #c2b280; --sidebar: #0d0d0d; --border: #222; }
        body { margin: 0; background: #000; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; color: #ccc; }
        
        #tab-bar { width: 50px; background: #111; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 15px; z-index: 3001; }
        .tab-btn { width: 38px; height: 38px; color: #444; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 15px; border-radius: 6px; }
        .tab-btn.active { color: var(--khaki); background: #2a2f24; border: 1px solid #3b4634; }
        .tab-btn svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; }

        #sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); z-index: 3000; transition: 0.3s; overflow-y: auto; }
        #sidebar.collapsed { width: 0; transform: translateX(-280px); }

        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 50px; width: calc(100vw - 50px); transform: translateX(-110%); }
            #sidebar.active { transform: translateX(0); }
        }

        .tab-page { display: none; padding: 20px; }
        .tab-page.active { display: block; }
        
        #map-container { position: relative; flex-grow: 1; height: 100vh; }
        #map { height: 100%; width: 100%; background: #000; }
        #paint-canvas { position: absolute; top: 0; left: 0; z-index: 1000; pointer-events: none; width: 100%; height: 100%; touch-action: none; }
        #paint-canvas.active { pointer-events: auto; cursor: crosshair; }

        .tool-btn { width: 100%; padding: 10px; background: #151515; border: 1px solid #333; color: #777; margin-bottom: 5px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
        .tool-btn.active { border-color: var(--khaki); color: #fff; background: #1a1e16; }

        .dot-container { background: transparent !important; border: none !important; }
        .pulsating-dot { width: 10px; height: 10px; background: #ff3b3b; border-radius: 50%; box-shadow: 0 0 10px #ff3b3b; }
    </style>
</head>
<body>

<div id="tab-bar">
    <div id="btn-layers" class="tab-btn active" onclick="handleTab('layers')"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg></div>
    <div id="btn-draw" class="tab-btn" onclick="handleTab('draw')"><svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></div>
</div>

<div id="sidebar">
    <div id="layers" class="tab-page active">
        <h3 style="color: #fff; font-size: 14px;">–£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–†–¢–û–ô</h3>
        <button class="tool-btn" onclick="toggleSatellite()" id="satBtn">üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–π —Ä–µ–∂–∏–º</button>
        <button class="tool-btn" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ JSON</button>
    </div>
    <div id="draw" class="tab-page">
        <h3 style="color: #fff; font-size: 14px;">–†–ò–°–û–í–ê–õ–ö–ê</h3>
        <button class="tool-btn active" id="brush-btn" onclick="setTool('brush', this)">üñåÔ∏è –ö–∏—Å—Ç—å</button>
        <button class="tool-btn" onclick="setTool('arrow', this)">‚ÜóÔ∏è –°—Ç—Ä–µ–ª–∫–∞</button>
        <input type="color" id="paint-color" value="#c2b280" style="width:100%; margin: 10px 0;">
        <button class="tool-btn" onclick="togglePaintMode()" id="toggle-paint-btn" style="background: #222; color: #fff; justify-content: center;">–í–ö–õ–Æ–ß–ò–¢–¨ –†–ò–°–û–í–ê–ù–ò–ï</button>
        <button class="tool-btn" onclick="clearCanvas()" style="color: #ff4444; justify-content: center;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    </div>
</div>

<div id="map-container">
    <canvas id="paint-canvas"></canvas>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–æ–µ–≤
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    const satTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const map = L.map('map', { attributionControl: false, zoomControl: false }).setView([48.3, 37.5], 7);
    darkTiles.addTo(map);

    let isSat = false;
    function toggleSatellite() {
        isSat = !isSat;
        if (isSat) { map.removeLayer(darkTiles); satTiles.addTo(map); }
        else { map.removeLayer(satTiles); darkTiles.addTo(map); }
        document.getElementById('satBtn').classList.toggle('active', isSat);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ JSON –ø–æ–ª–∏–≥–æ–Ω–æ–≤
    let geoLayer;
    const pulsingIcon = L.divIcon({ className: 'dot-container', html: '<div class="pulsating-dot"></div>' });

    async function loadData() {
        try {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ –±—Ä–∞–ª —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –∏–∑ –∫—ç—à–∞
            const response = await fetch('data/map.json?nocache=' + Math.random());
            if (!response.ok) throw new Error("–§–∞–π–ª data/map.json –Ω–µ –Ω–∞–π–¥–µ–Ω");
            const data = await response.json();

            if (geoLayer) map.removeLayer(geoLayer);

            geoLayer = L.geoJSON(data, {
                style: (feature) => ({
                    fillColor: feature.properties.color || "#8b0000",
                    color: feature.properties.color || "#8b0000",
                    weight: 2,
                    fillOpacity: 0.4
                }),
                pointToLayer: (feature, latlng) => L.marker(latlng, { icon: pulsingIcon }),
                onEachFeature: (feature, layer) => {
                    if (feature.properties && feature.properties.name) {
                        layer.on('click', () => {
                            if (layer.getTooltip()) { layer.unbindTooltip(); }
                            else { layer.bindTooltip(feature.properties.name, { permanent: true }).openTooltip(); }
                        });
                    }
                }
            }).addTo(map);

            // –§–û–ö–£–°: –ö–∞—Ä—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Ç–≤–æ–∏—Ö –ø–æ–ª–∏–≥–æ–Ω–∞—Ö
            const bounds = geoLayer.getBounds();
            if (bounds.isValid()) map.fitBounds(bounds);

            console.log("–ü–æ–ª–∏–≥–æ–Ω—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞:", err);
            alert("–ü–æ–ª–∏–≥–æ–Ω—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ 'data' –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å index.html");
        }
    }

    // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    function handleTab(id) {
        document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('btn-' + id).classList.add('active');
        document.getElementById('sidebar').classList.remove('collapsed');
        if (window.innerWidth <= 768) document.getElementById('sidebar').classList.add('active');
        setTimeout(() => map.invalidateSize(), 200);
    }

    // –†–∏—Å–æ–≤–∞–ª–∫–∞ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω)
    const canvas = document.getElementById('paint-canvas'), ctx = canvas.getContext('2d');
    let isPaintingMode = false, isDrawing = false, tool = 'brush', snapshot;

    function resizeCanvas() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    function togglePaintMode() {
        isPaintingMode = !isPaintingMode;
        const btn = document.getElementById('toggle-paint-btn');
        btn.innerText = isPaintingMode ? "–í–´–ö–õ–Æ–ß–ò–¢–¨ –†–ò–°–û–í–ê–ù–ò–ï" : "–í–ö–õ–Æ–ß–ò–¢–¨ –†–ò–°–û–í–ê–ù–ò–ï";
        btn.style.background = isPaintingMode ? "#8b0000" : "#222";
        canvas.classList.toggle('active', isPaintingMode);
        isPaintingMode ? map.dragging.disable() : map.dragging.enable();
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function startDraw(e) {
        if (!isPaintingMode) return;
        isDrawing = true;
        const pos = getPos(e);
        ctx.strokeStyle = document.getElementById('paint-color').value;
        ctx.lineWidth = 3; ctx.lineCap = 'round';
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
        if (tool === 'brush') { ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
        else { startX = pos.x; startY = pos.y; }
    }

    function moveDraw(e) {
        if (!isDrawing) return;
        if (e.cancelable) e.preventDefault();
        const pos = getPos(e);
        if (tool === 'brush') { ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
        else {
            ctx.putImageData(snapshot, 0, 0);
            if (tool === 'arrow') drawArrow(startX, startY, pos.x, pos.y);
        }
    }

    function drawArrow(x1, y1, x2, y2) {
        const head = 15, angle = Math.atan2(y2-y1, x2-x1);
        ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
        ctx.lineTo(x2-head*Math.cos(angle-Math.PI/6), y2-head*Math.sin(angle-Math.PI/6));
        ctx.moveTo(x2, y2); ctx.lineTo(x2-head*Math.cos(angle+Math.PI/6), y2-head*Math.sin(angle+Math.PI/6));
        ctx.stroke();
    }

    canvas.addEventListener('mousedown', startDraw);
    window.addEventListener('mousemove', moveDraw);
    window.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('touchstart', (e) => { if(isPaintingMode) startDraw(e); }, {passive: false});
    canvas.addEventListener('touchmove', moveDraw, {passive: false});
    canvas.addEventListener('touchend', () => isDrawing = false);

    function setTool(t, btn) {
        tool = t;
        document.querySelectorAll('#draw .tool-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    // –°—Ç–∞—Ä—Ç
    loadData();
</script>
</body>
</html>
