<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PolitMap | Tactical Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --army-red: #8b0000;
            --khaki: #c2b280;
            --sidebar-bg: #0d0d0d;
            --border-color: #222;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; color: #ccc; }

        /* –°–ê–ô–î–ë–ê–† –ò –ò–ù–¢–ï–†–§–ï–ô–° */
        #tab-bar { width: 60px; min-width: 60px; background: #111; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 10001; }
        #sidebar { width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); z-index: 10000; display: flex; flex-direction: column; transition: all 0.3s ease; }
        #sidebar.collapsed { width: 0; min-width: 0; border-right: none; transform: translateX(-10px); opacity: 0; pointer-events: none; }

        .tab-btn { width: 44px; height: 44px; color: #444; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 20px; border-radius: 8px; transition: 0.2s; }
        .tab-btn.active { color: var(--khaki); background: #1a1e16; border: 1px solid #3b4634; }
        .tab-btn svg { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }

        .tab-page { display: none; padding: 25px 20px; height: 100%; overflow-y: auto; min-width: 300px; }
        .tab-page.active { display: block; }

        .tool-btn { width: 100%; padding: 12px; background: #151515; border: 1px solid #333; color: #888; margin-bottom: 8px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 11px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; }
        .tool-btn.active { border-color: var(--khaki); color: #fff; background: #1a1e16; }
        .tool-btn.main-action { background: var(--army-red); color: #fff; border: none; justify-content: center; }

        .switch-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 12px; background: #151515; border-radius: 6px; border: 1px solid #222; }
        .switch { position: relative; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #333; border-radius: 20px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background: var(--army-red); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* –ö–ê–†–¢–ê */
        #map-wrap { position: relative; flex-grow: 1; height: 100vh; z-index: 1; background: #000; }
        #map { height: 100%; width: 100%; z-index: 10; }
        #paint-canvas { position: absolute; top: 0; left: 0; z-index: 5000; width: 100%; height: 100%; touch-action: none; pointer-events: none; }
        #paint-canvas.active { pointer-events: auto; cursor: crosshair; }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –¢–û–ß–ö–ê (–ë–ï–ó –ë–ï–õ–û–ì–û –ö–†–£–ì–ê) */
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è */
.dot-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
}

/* –°–∞–º–æ —è–¥—Ä–æ (–∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞) */
.pulsating-dot { 
    width: 8px; 
    height: 8px; 
    background: #ff3b3b; 
    border-radius: 50%; 
    position: relative;
    box-shadow: 0 0 12px #ff3b3b; /* –ú—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –±–µ–ª–æ–π –æ–±–≤–æ–¥–∫–∏ */
}

/* –ü—É–ª—å—Å–∏—Ä—É—é—â–µ–µ –∫–æ–ª—å—Ü–æ */
.pulsating-dot::after {
    content: '';
    position: absolute;
    /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–æ–ª—å—Ü–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —è–¥—Ä–∞ */
    top: 50%;
    left: 50%;
    width: 8px;
    height: 8px;
    margin: -4px 0 0 -4px; /* –°–º–µ—â–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω—É —Ä–∞–∑–º–µ—Ä–∞ –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ */
    border-radius: 50%; 
    border: 2px solid #ff3b3b; 
    animation: pulsate-clean 1.8s ease-out infinite; 
    box-sizing: border-box;
}

@keyframes pulsate-clean {
    0% { 
        transform: scale(1); 
        opacity: 0.8; 
    }
    100% { 
        transform: scale(5); 
        opacity: 0; 
    }
}
        .custom-tooltip { background: #000 !important; border: 1px solid var(--khaki) !important; color: #fff !important; font-weight: bold; font-size: 11px; padding: 4px 8px; border-radius: 0; }
    </style>
</head>
<body>

<div id="tab-bar">
    <div class="tab-btn active" id="btn-map" onclick="toggleTab('map')"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg></div>
    <div class="tab-btn" id="btn-draw" onclick="toggleTab('draw')"><svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></div>
    <div class="tab-btn" id="btn-don" onclick="toggleTab('don')"><svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M6 12h.01M18 12h.01"/></svg></div>
</div>

<div id="sidebar">
    <div id="t-map" class="tab-page active">
        <h2>–ö–∞—Ä—Ç–∞</h2>
        <div class="switch-group"><span>–°–ø—É—Ç–Ω–∏–∫ + OSM</span><label class="switch"><input type="checkbox" id="sat-switch" onchange="toggleLayers()"><span class="slider"></span></label></div>
        <div class="switch-group"><span>–û–±—ä–µ–∫—Ç—ã JSON</span><label class="switch"><input type="checkbox" id="border-switch" checked onchange="updateGeoVisibility()"><span class="slider"></span></label></div>
        <button class="tool-btn" onclick="loadMapData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>

    <div id="t-draw" class="tab-page">
        <h2>–†–∏—Å–æ–≤–∞–Ω–∏–µ</h2>
        <button class="tool-btn active" id="tool-brush" onclick="setTool('brush')">–ö–∏—Å—Ç—å</button>
        <button class="tool-btn" id="tool-arrow" onclick="setTool('arrow')">–°—Ç—Ä–µ–ª–∫–∞</button>
        <button class="tool-btn" id="tool-circle" onclick="setTool('circle')">–ö—Ä—É–≥</button>
        <input type="color" id="m-color" value="#c2b280" style="width:100%; height:35px; border:1px solid #333; background:none; margin:10px 0;">
        <button class="tool-btn main-action" id="draw-btn" onclick="togglePaint()">–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è</button>
        <button class="tool-btn" onclick="clearCanvas()" style="margin-top:10px;">‚ùå –°—Ç–µ—Ä–µ—Ç—å –≤—Å—ë</button>
    </div>

    <div id="t-don" class="tab-page">
        <h2>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
        <div style="background:#111; padding:15px; border-radius:8px; text-align:center;">
            <div style="font-family:monospace; font-size:16px; margin-bottom:10px;">2200 0000 0000 0000</div>
            <button class="tool-btn main-action" onclick="alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<div id="map-wrap">
    <canvas id="paint-canvas"></canvas>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. –ö–ê–†–¢–ê
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const osmLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png');

    const map = L.map('map', { zoomControl: false, attributionControl: false, layers: [darkTiles] }).setView([48.3, 37.5], 7);

    function toggleLayers() {
        const isSat = document.getElementById('sat-switch').checked;
        if(isSat) {
            map.removeLayer(darkTiles); map.addLayer(esriSat); map.addLayer(osmLabels);
        } else {
            map.removeLayer(esriSat); map.removeLayer(osmLabels); map.addLayer(darkTiles);
        }
    }

    // 2. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• (–¢–û–ß–ö–ò + –§–†–û–ù–¢)
    let geoJsonLayer = null;

    async function loadMapData() {
        try {
            const response = await fetch('data/map.json?v=' + Date.now());
            if (!response.ok) return;
            const data = await response.json();
            
            if(geoJsonLayer) map.removeLayer(geoJsonLayer);
            
            geoJsonLayer = L.geoJSON(data, {
                // –°–¢–ò–õ–¨ –î–õ–Ø –õ–ò–ù–ò–ô –ò –ü–û–õ–ò–ì–û–ù–û–í (–§–†–û–ù–¢)
                style: (f) => ({
                    color: f.properties.color || "#8b0000",
                    weight: f.geometry.type === "LineString" ? 3 : 2,
                    fillColor: f.properties.color || "#8b0000",
                    fillOpacity: 0.2,
                    dashArray: f.properties.dash ? '5, 10' : null
                }),
                // –°–¢–ò–õ–¨ –î–õ–Ø –¢–û–ß–ï–ö
                pointToLayer: (f, ll) => {
                    const marker = L.marker(ll, { 
                        icon: L.divIcon({ 
                            className: '', 
                            html: '<div class="dot-container"><div class="pulsating-dot"></div></div>', 
                            iconSize: [20,20], iconAnchor: [10,10] 
                        }) 
                    });
                    
                    // –ö–õ–ò–ö –î–õ–Ø –ü–û–ö–ê–ó–ê –õ–ï–ô–ë–õ–ê
                    marker.on('click', function() {
                        if (this.getTooltip()) {
                            this.unbindTooltip();
                        } else {
                            this.bindTooltip(f.properties.name || "–û–±—ä–µ–∫—Ç", { 
                                className: 'custom-tooltip', 
                                direction: 'top', 
                                offset: [0, -10] 
                            }).openTooltip();
                        }
                    });
                    return marker;
                },
                // –ö–õ–ò–ö –î–õ–Ø –ü–û–õ–ò–ì–û–ù–û–í (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
                onEachFeature: (f, l) => {
                    if (f.geometry.type !== "Point") {
                        l.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            L.popup().setLatLng(e.latlng).setContent(f.properties.name || "–ó–æ–Ω–∞").openOn(map);
                        });
                    }
                }
            });
            updateGeoVisibility();
        } catch(e) { console.warn("–§–∞–π–ª JSON –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω"); }
    }

    function updateGeoVisibility() {
        if(!geoJsonLayer) return;
        document.getElementById('border-switch').checked ? map.addLayer(geoJsonLayer) : map.removeLayer(geoJsonLayer);
    }

    // 3. –ò–ù–¢–ï–†–§–ï–ô–°
    function toggleTab(id) {
        document.querySelectorAll('.tab-btn, .tab-page').forEach(el => el.classList.remove('active'));
        document.getElementById('sidebar').classList.remove('collapsed');
        document.getElementById('btn-' + id).classList.add('active');
        document.getElementById('t-' + id).classList.add('active');
        setTimeout(() => map.invalidateSize(), 300);
    }

    // 4. –†–ò–°–û–í–ê–õ–ö–ê
    const canvas = document.getElementById('paint-canvas'), ctx = canvas.getContext('2d');
    let isDrawing = false, currentTool = 'brush', snapshot, startX, startY;

    function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.addEventListener('resize', resize); resize();

    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    function togglePaint() {
        const active = canvas.classList.toggle('active');
        document.getElementById('draw-btn').innerText = active ? "–í–´–ö–õ–Æ–ß–ò–¢–¨" : "–†–ï–ñ–ò–ú –†–ò–°–û–í–ê–ù–ò–Ø";
        active ? (map.dragging.disable(), map.touchZoom.disable()) : (map.dragging.enable(), map.touchZoom.enable());
    }

    function setTool(t) {
        currentTool = t;
        document.querySelectorAll('#t-draw .tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tool-' + t).classList.add('active');
    }

    canvas.addEventListener('pointerdown', (e) => {
        if(!canvas.classList.contains('active')) return;
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        startX = e.clientX - rect.left; startY = e.clientY - rect.top;
        ctx.strokeStyle = document.getElementById('m-color').value;
        ctx.lineWidth = 3; ctx.lineCap = 'round';
        snapshot = ctx.getImageData(0,0, canvas.width, canvas.height);
        if(currentTool === 'brush') { ctx.beginPath(); ctx.moveTo(startX, startY); }
    });

    canvas.addEventListener('pointermove', (e) => {
        if(!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left, y = e.clientY - rect.top;
        if(currentTool === 'brush') { ctx.lineTo(x, y); ctx.stroke(); }
        else {
            ctx.putImageData(snapshot, 0, 0); ctx.beginPath();
            if(currentTool === 'arrow') {
                const a = Math.atan2(y - startY, x - startX);
                ctx.moveTo(startX, startY); ctx.lineTo(x, y);
                ctx.lineTo(x - 12 * Math.cos(a - 0.5), y - 12 * Math.sin(a - 0.5));
                ctx.moveTo(x, y); ctx.lineTo(x - 12 * Math.cos(a + 0.5), y - 12 * Math.sin(a + 0.5));
            } else if(currentTool === 'circle') {
                ctx.arc(startX, startY, Math.sqrt((x-startX)**2 + (y-startY)**2), 0, Math.PI*2);
            }
            ctx.stroke();
        }
    });

    window.addEventListener('pointerup', () => isDrawing = false);

    loadMapData();
</script>
</body>
</html>

